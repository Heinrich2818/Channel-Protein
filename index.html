<script>
  const CSV_URL = `data.csv?v=${Date.now()}`; // cache-busting
  const esc = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

  // Map headers and coerce numerics
  function normalizeRows(rows) {
    const map = {
      "channel":"Channel","design":"Design","n":"n",
      "mpnn":"MPNN","plddt":"pLDDT","i_ptm":"iPTM","i_pae":"iPAE","rmsd":"RMSD","seq":"Sequence"
    };
    const rawHeaders = Object.keys(rows[0] || {});
    const headers = rawHeaders.map(h => map[h.trim().toLowerCase()] || h.trim());

    const data = rows.map(r => {
      const obj = {};
      rawHeaders.forEach((rh,i) => obj[headers[i]] = (r[rh] ?? "").toString().trim());
      // numbers
      ["MPNN","pLDDT","iPTM","iPAE","RMSD","n","Design"].forEach(k=>{
        if (obj[k] !== "") obj[k] = Number(obj[k]);
      });
      const seq = (obj["Sequence"] || "").replace(/\s/g,"");
      obj["SeqLen"] = seq.length;
      return obj;
    });
    return data;
  }

  let table;

  /* Robust numeric range filter — safe before table exists */
  $.fn.dataTable.ext.search = $.fn.dataTable.ext.search || [];
  $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
    if (!settings.nTable || settings.nTable.id !== 'dataTable') return true;

    // Safe access during early draws
    const row = (settings.aoData && settings.aoData[dataIndex] && settings.aoData[dataIndex]._aData) || {};
    const num = v => (v === "" || v == null ? NaN : Number(v));
    const rmsd  = num(row.RMSD);
    const iPAE  = num(row.iPAE);
    const pLDDT = num(row.pLDDT);

    const val = id => parseFloat(document.getElementById(id)?.value);
    const inRange = (v, min, max) =>
      (isNaN(min) || (isNaN(v) ? true : v >= min)) &&
      (isNaN(max) || (isNaN(v) ? true : v <= max));

    return inRange(rmsd,  val('rmsdMin'),  val('rmsdMax')) &&
           inRange(iPAE,  val('paeMin'),   val('paeMax'))  &&
           inRange(pLDDT, val('plddtMin'), val('plddtMax'));
  });

  function buildChannelFilter(rows) {
    const select = document.getElementById('channelFilter');
    const uniq = Array.from(new Set(rows.map(r => r["Channel"]).filter(Boolean))).sort();
    uniq.forEach(ch => {
      const opt = document.createElement('option');
      opt.value = ch; opt.textContent = ch;
      select.appendChild(opt);
    });
    select.addEventListener('change', () => {
      if (!table) return;
      table.column(0).search(select.value ? `^${select.value}$` : '', true, false).draw();
    });
  }

  function initTable(rows) {
    buildChannelFilter(rows);

    table = $('#dataTable').DataTable({
      data: rows,
      responsive: true,
      deferRender: true,
      pageLength: 10,
      lengthMenu: [10, 25, 50, 100],
      dom: 'Bfrtip',
      buttons: [{ extend: 'csvHtml5', text: 'Export filtered CSV', title: 'ion_channel_table' }],
      columns: [
        { title: 'Channel', data: 'Channel', className: 'all' },
        { title: 'Design',  data: 'Design',  className: 'min-tablet' },
        { title: 'n',       data: 'n',       className: 'min-tablet' },
        { title: 'MPNN',    data: 'MPNN',    className: 'min-tablet',
          render: (d,t)=>{ const v=Number(d); if(t==='sort'||t==='type') return isNaN(v)?-Infinity:v; return isNaN(v)?'':v.toFixed(6);} },
        { title: 'pLDDT',   data: 'pLDDT',   className: 'all',
          render: (d,t)=>{ const v=Number(d); if(t==='sort'||t==='type') return isNaN(v)?-Infinity:v; return isNaN(v)?'':v.toFixed(6);} },
        { title: 'iPTM',    data: 'iPTM',    className: 'min-tablet',
          render: (d,t)=>{ const v=Number(d); if(t==='sort'||t==='type') return isNaN(v)?-Infinity:v; return isNaN(v)?'':v.toFixed(6);} },
        { title: 'iPAE',    data: 'iPAE',    className: 'min-tablet',
          render: (d,t)=>{ const v=Number(d); if(t==='sort'||t==='type') return isNaN(v)?-Infinity:v; return isNaN(v)?'':v.toFixed(6);} },
        { title: 'RMSD',    data: 'RMSD',    className: 'all',
          render: (d,t)=>{ const v=Number(d); if(t==='sort'||t==='type') return isNaN(v)?-Infinity:v; return isNaN(v)?'':v.toFixed(6);} },
        { title: 'SeqLen',  data: 'SeqLen',  className: 'min-tablet', searchable: false },
        { title: 'Sequence', data: 'Sequence', className: 'none', orderable: false,
          render: (data, type, row) => {
            if (type !== 'display') return data;
            const seq = data || '';
            const len = row.SeqLen ?? (seq.replace(/\s/g,"").length);
            const short = len > 30 ? `${seq.slice(0,12)}…${seq.slice(-12)}` : seq;
            return `<details>
                      <summary><code>${esc(short)}</code> <small>(len ${len})</small></summary>
                      <div style="white-space:pre-wrap;word-break:break-all;">
                        <code>${esc(seq)}</code>
                        <button class="copy-btn" data-seq="${esc(seq)}">Copy sequence</button>
                      </div>
                    </details>`;
          }
        }
      ]
    });

    document.getElementById('globalSearch').addEventListener('input', e => {
      table.search(e.target.value).draw();
    });

    // live range filters
    ['rmsdMin','rmsdMax','paeMin','paeMax','plddtMin','plddtMax'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        table.draw();
        const total = table.rows({ filter: 'applied' }).count();
        document.getElementById('status').textContent =
          `Loaded ${table.rows().count()} records • ${total} after filters`;
      });
    });

    // copy sequence
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.copy-btn');
      if (!btn) return;
      const seq = btn.getAttribute('data-seq')?.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&') || '';
      try {
        await navigator.clipboard.writeText(seq);
        btn.textContent = 'Copied';
        setTimeout(() => btn.textContent = 'Copy sequence', 1000);
      } catch {
        btn.textContent = 'Copy failed';
        setTimeout(() => btn.textContent = 'Copy sequence', 1000);
      }
    });

    document.getElementById('status').textContent = `Loaded ${rows.length} records`;
  }

  // Load CSV
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (res) => {
      try {
        const rows = (res.data || []).filter(r => r && Object.values(r).some(v => String(v ?? "").trim() !== ""));
        if (!rows.length) throw new Error("CSV is empty or header row is missing.");
        initTable(normalizeRows(rows));
      } catch (e) {
        document.getElementById('status').textContent = "Parse failed: " + e.message;
        console.error(e);
      }
    },
    error: (err) => {
      document.getElementById('status').textContent = "Failed to load data.csv (is GitHub Pages deployed?)";
      console.error(err);
    }
  });
</script>
